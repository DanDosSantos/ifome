{% extends 'base.html' %}
{% block title %}iFome - Restaurante{% endblock %}
{% block messages %}{% endblock %}  <!-- remove mensagens flashes nesta página -->
{% block content %}
    <div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
        <div class="flex items-center gap-6">
            <img src="{{ url_for('static', filename=restaurante.imagem_restaurante.split('static/')[1]) }}" alt="Imagem do Restaurante" class="w-32 h-32 object-cover rounded-full mb-4">
            <h1 id="nome" class="text-3xl font-bold text-gray-800">Carregando...</h1>
            <span class="text-yellow-99-dark">★ 4.8</span>
        </div>

        <div class="mt-4">
            <label><b>Telefone</b></label>
            <p id="telefone" class="text-gray-600 mb-4"></p>
            <label><b>Endereço</b></label>
            <p id="endereco" class="text-gray-600 mb-4"></p>
            <label><b>Horário de funcionamento</b></label>
            <p id="hora_funcionamento" class="text-gray-600 mb-4"></p>
        </div>
    </div>

    <div id="container" class="max-w-7xl mx-auto mt-8 bg-white p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Cardápio</h2>
        {% for c in cardapio %}
        <!-- se tiver o status do cardápio estiver ativo... -->
            {% if c.ativo != false %}
                 <section class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">{{ c.nome_cardapio }}</h3>

                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                      {% for p in c.produtos %}
                        {% if p.disponivel != false %}
                          <div class="bg-white border rounded-lg overflow-hidden shadow-sm hover:border-gray-400" style="aspect-ratio:1/1;" id="add-produto">
                            <div class="p-4 h-full flex flex-col justify-between">
                              <div>
                                <div class="font-medium text-lg text-gray-800 truncate">{{ p.nome_item }}</div>
                                <div class="text-sm text-gray-500 mt-2 line-clamp-3">{{ p.descricao }}</div>
                              </div>
                              <div class="mt-3 text-right">
                                <span class="text-green-600 font-semibold text-lg">R$ {{ '%.2f'|format(p.preco) }}</span>
                              </div>
                            </div>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                </section>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Overlay escuro -->
    <div id="produto-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"></div>
    <!-- Modal -->
    <div id="produto-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 relative">
        <button id="close-produto-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-xl font-bold" aria-label="Fechar">&times;</button>
        <h2 id="modal-nome" class="text-2xl font-bold mb-2"></h2>
        <p id="modal-descricao" class="text-gray-600 mb-4"></p>
        <div class="flex items-center justify-between mb-4">
          <span id="modal-preco" class="text-green-600 font-semibold text-lg"></span>
          <div class="flex items-center gap-2">
            <button id="modal-quant-menor" class="bg-gray-200 px-3 py-1 rounded text-xl font-bold">-</button>
            <span id="modal-quantidade" class="font-bold text-lg">1</span>
            <button id="modal-quant-maior" class="bg-gray-200 px-3 py-1 rounded text-xl font-bold">+</button>
          </div>
        </div>
        <div class="text-right mb-2">
          <span id="modal-total" class="text-green-600 font-bold text-lg"></span>
        </div>
        <button id="modal-adicionar" class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 rounded-lg mt-2">Adicionar</button>
      </div>
    </div>
{% endblock content %}

{% block scripts %}
    <!-- Importa o JS do carrinho lateral -->
     <script src="{{ url_for('static', filename='js/carrinho.js') }}"></script>

    <script>
        const restauranteId = "{{ restaurante_id }}";

        // faz uma requisição assíncrona para buscar dados da API
        fetch(`/api/restaurantes/${restauranteId}`)
            .then(res => res.json())
            .then(data => {
                if (data.erro) {
                    document.getElementById('container').innerHTML = `<p class="text-red-500">${data.erro}</p>`;
                    return;
                }

                document.getElementById('nome').textContent = data.nome;
                document.getElementById('hora_funcionamento').textContent = `${data.hora_abertura} - ${data.hora_fechamento}`;
                document.getElementById('telefone').textContent = data.telefone;
                document.getElementById('endereco').textContent = `${data.endereco.rua}, ${data.endereco.numero} - ${data.endereco.bairro} - ${data.endereco.cidade}, ${data.endereco.estado}, ${data.endereco.cep}`;

                // const ul = document.getElementById('cardapio');
                // data.cardapio.forEach(item => {
                //     const li = document.createElement('li');
                //     li.className = "flex justify-between border-b pb-2";
                //     li.innerHTML = `<span>${item.nome}</span><span class="text-gray-700 font-medium">R$ ${item.preco}</span>`;
                //     ul.appendChild(li);
                // });
            })
            .catch(err => {
                document.getElementById('container').innerHTML = `<p class="text-red-500">Erro ao carregar restaurante.</p>`;
            });            

            // MODAL
            const overlay = document.getElementById('produto-modal-overlay');
            const modal = document.getElementById('produto-modal');
            const closeBtn = document.getElementById('close-produto-modal');
            const nomeEl = document.getElementById('modal-nome');
            const descEl = document.getElementById('modal-descricao');
            const precoEl = document.getElementById('modal-preco');
            const quantEl = document.getElementById('modal-quantidade');
            const menosBtn = document.getElementById('modal-quant-menor');
            const maisBtn = document.getElementById('modal-quant-maior');
            const addBtn = document.getElementById('modal-adicionar');
            const totalEl = document.getElementById('modal-total');

            let produtoAtual = null;
            let quantidade = 1;
            let precoUnitario = 0;

            function atualizarTotal() {
              const total = precoUnitario * quantidade;
              totalEl.textContent = `Adicionar: R$ ${total.toFixed(2)}`;
            }

            function abrirModal(produto) {
              produtoAtual = produto;
              nomeEl.textContent = produto.nome_item;
              descEl.textContent = produto.descricao || '';
              precoUnitario = parseFloat(produto.preco);
              quantidade = 1;
              quantEl.textContent = quantidade;
              atualizarTotal();
              overlay.classList.remove('hidden');
              modal.classList.remove('hidden');
            }

            function fecharModal() {
              overlay.classList.add('hidden');
              modal.classList.add('hidden');
            }

            menosBtn.onclick = () => {
              if (quantidade > 1) quantidade--;
              quantEl.textContent = quantidade;
              atualizarTotal();
            };
            maisBtn.onclick = () => {
              quantidade++;
              quantEl.textContent = quantidade;
              atualizarTotal();
            };

            closeBtn.onclick = fecharModal;
            overlay.onclick = fecharModal;

            addBtn.onclick = () => {
              window.adicionarAoCarrinho(produtoAtual, quantidade);
              fecharModal();
              const drawer = document.getElementById('cart-drawer');
              if (drawer) drawer.classList.remove('translate-x-full');
            };

            // Adiciona evento a todos os produtos
            document.querySelectorAll('#add-produto').forEach(card => {
              card.onclick = function() {
                const nome = card.querySelector('.font-medium').textContent;
                const descricao = card.querySelector('.text-sm').textContent;
                const preco = card.querySelector('.text-green-600').textContent.replace('R$','').trim();
                abrirModal({ nome_item: nome, descricao: descricao, preco: preco });
              };
            });
    </script>
{% endblock %}