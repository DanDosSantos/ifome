{% extends 'base.html' %}
{% block title %}Finalizar Pedido - iFome{% endblock %}
{% block navbar %}{% endblock %}
{% block content %}
    <!-- Navbar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex justify-center items-center w-full">
                    <a href="{{ url_for('home.index') }}">
                    <!-- Logo PNG -->
                    <img class="h-12 w-auto" src="{{ url_for('static', filename='ifome-branco.png') }}" alt="ifome Logo" />
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Finalizar Pedido</h1>
            <p class="text-gray-600">Revise seu pedido e confirme os dados para entrega</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Resumo do Pedido -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <svg class="w-6 h-6 text-yellow-99-dark mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"></path>
                        </svg>
                        Resumo do Pedido
                    </h2>

                    <!-- Lista de Produtos -->
                    <div id="cart-items" class="space-y-4">
                        <!-- Os itens do carrinho ser√£o inseridos aqui via JS -->
                    </div>

                    <!-- Observa√ß√µes do Pedido -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Observa√ß√µes do Pedido</h3>
                        <textarea id="order-notes" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-99 focus:border-transparent resize-none"
                                  rows="3"
                                  placeholder="Adicione observa√ß√µes especiais para seu pedido (ex: sem cebola, entregar na portaria, etc.)"></textarea>
                    </div>
                </div>
            </div>

            <!-- Sidebar - Endere√ßo e Resumo -->
            <div class="lg:col-span-1">
                <!-- Endere√ßo de Entrega -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-yellow-99-dark mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Endere√ßo de Entrega
                    </h3>

                    <!-- Endere√ßo do usu√°rio -->
                    <div id="selected-address" class="border border-yellow-99 bg-yellow-99/5 rounded-lg p-4 mb-4">
                        {% if usuario and usuario.endereco %}
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900">üè† {{ usuario.endereco.nome_endereco or 'Casa' }}</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    {{ usuario.endereco.rua }}, {{ usuario.endereco.numero }} {{ usuario.endereco.complemento }}<br>
                                    {{ usuario.endereco.bairro }} - {{ usuario.endereco.cidade }}, {{ usuario.endereco.estado }}<br>
                                    CEP: {{ usuario.endereco.cep }}
                                </p>
                            </div>
                        {% else %}
                            <div class="text-gray-500">Nenhum endere√ßo cadastrado.</div>
                        {% endif %}
                    </div>

                    <!-- Bot√µes de Endere√ßo -->
                    <div class="space-y-2">
                        <button id="change-address-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium transition duration-200">
                            Alterar Endere√ßo
                        </button>
                        <button id="add-address-btn" class="w-full bg-yellow-99 hover:bg-yellow-99-dark text-black py-2 px-4 rounded-lg font-medium transition duration-200">
                            + Adicionar Novo Endere√ßo
                        </button>
                    </div>
                </div>

                <!-- Resumo de Valores -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumo de Valores</h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-semibold">R$ <span id="subtotal-value">98,40</span></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Taxa de entrega</span>
                            <span class="font-semibold text-green-600">Gr√°tis</span>
                        </div>
                        <div class="border-t border-gray-200 pt-3">
                            <div class="flex justify-between">
                                <span class="text-lg font-bold text-gray-900">Total</span>
                                <span class="text-lg font-bold text-yellow-99-dark">R$ <span id="total-value">98,40</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="space-y-3">
                    <button id="confirm-order-btn" class="w-full bg-yellow-99 hover:bg-yellow-99-dark text-black py-4 px-6 rounded-lg text-lg font-bold transition duration-200 transform hover:scale-105">
                        Confirmar Pedido
                    </button>
                    <button id="back-to-cart-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-6 rounded-lg font-medium transition duration-200">
                        ‚Üê Voltar ao Carrinho
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Pedido Confirmado!</h3>
            <p class="text-gray-600 mb-6">
                Seu pedido foi registrado com sucesso.<br>
                A nota fiscal foi enviada por e-mail.
            </p>
            <div class="space-y-3">
                <button id="track-order-btn" class="w-full bg-yellow-99 hover:bg-yellow-99-dark text-black py-3 px-6 rounded-lg font-bold transition duration-200">
                    Acompanhar Pedido
                </button>
                <button id="close-modal-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-6 rounded-lg font-medium transition duration-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Sele√ß√£o de Endere√ßo -->
    <div id="address-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 max-w-lg mx-4 w-full max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Selecionar Endere√ßo</h3>
                <button id="close-address-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-3">
                <!-- Endere√ßo 1 -->
                <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-yellow-99 address-option" data-address-id="1">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">üè† Casa</p>
                            <p class="text-sm text-gray-600 mt-1">
                                Rua das Flores, 123 - Apto 45<br>
                                Centro - S√£o Paulo, SP<br>
                                CEP: 01234-567
                            </p>
                        </div>
                        <div class="w-4 h-4 border-2 border-gray-300 rounded-full address-radio"></div>
                    </div>
                </div>

                <!-- Endere√ßo 2 -->
                <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-yellow-99 address-option" data-address-id="2">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">üè¢ Trabalho</p>
                            <p class="text-sm text-gray-600 mt-1">
                                Av. Paulista, 1000 - Sala 501<br>
                                Bela Vista - S√£o Paulo, SP<br>
                                CEP: 01310-100
                            </p>
                        </div>
                        <div class="w-4 h-4 border-2 border-gray-300 rounded-full address-radio"></div>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200">
                <button class="w-full bg-yellow-99 hover:bg-yellow-99-dark text-black py-3 px-6 rounded-lg font-bold transition duration-200">
                    + Adicionar Novo Endere√ßo
                </button>
            </div>
        </div>
    </div>
{% endblock content %}
{% block footer %}{% endblock %}  <!-- NAO exibe o footer da base -->

{% block scripts %}
    <script>
        function getCartItems() {
            const carrinhoSalvo = localStorage.getItem('carrinho');
            return carrinhoSalvo ? JSON.parse(carrinhoSalvo) : [];
        }

        function setCartItems(items) {
            localStorage.setItem('carrinho', JSON.stringify(items));
        }

        function renderCartItems() {
            let cartItems = getCartItems();
            const cartDiv = document.getElementById('cart-items');
            cartDiv.innerHTML = '';
            if (cartItems.length === 0) {
                cartDiv.innerHTML = '<div class="text-center py-8 text-gray-500">Seu carrinho est√° vazio</div>';
                return;
            }
            cartItems.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = "border border-gray-200 rounded-lg p-4 cart-item";
                div.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div>
                                    <h3 class="font-semibold text-gray-900">${item.nome_item}</h3>
                                </div>
                            </div>
                        </div>
                        <button class="text-red-500 hover:text-red-700 p-1 remove-item" data-idx="${idx}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center space-x-3">
                            <button class="minus bg-gray-200 px-2 rounded" data-idx="${idx}">-</button>
                            <span class="quantity font-semibold text-lg w-8 text-center">${item.quantidade}</span>
                            <button class="plus bg-yellow-99 px-2 rounded" data-idx="${idx}">+</button>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">R$ <span class="unit-price">${item.preco.toFixed(2).replace('.', ',')}</span></p>
                            <p class="font-bold text-lg">R$ <span class="subtotal">${(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</span></p>
                        </div>
                    </div>
                `;
                cartDiv.appendChild(div);
            });

            // Eventos dos bot√µes
            cartDiv.querySelectorAll('.plus').forEach(btn => {
                btn.onclick = function() {
                    let cartItems = getCartItems();
                    const idx = parseInt(this.dataset.idx);
                    cartItems[idx].quantidade++;
                    setCartItems(cartItems);
                    renderCartItems();
                    calculateTotals();
                };
            });
            cartDiv.querySelectorAll('.minus').forEach(btn => {
                btn.onclick = function() {
                    let cartItems = getCartItems();
                    const idx = parseInt(this.dataset.idx);
                    if (cartItems[idx].quantidade > 1) {
                        cartItems[idx].quantidade--;
                        setCartItems(cartItems);
                        renderCartItems();
                        calculateTotals();
                    }
                };
            });
            cartDiv.querySelectorAll('.remove-item').forEach(btn => {
                btn.onclick = function() {
                    let cartItems = getCartItems();
                    const idx = parseInt(this.dataset.idx);
                    cartItems.splice(idx, 1);
                    setCartItems(cartItems);
                    renderCartItems();
                    calculateTotals();
                };
            });
        }

        function calculateTotals() {
            let cartItems = getCartItems();
            let subtotal = 0;
            cartItems.forEach(item => {
                subtotal += item.preco * item.quantidade;
            });
            document.getElementById('subtotal-value').textContent = subtotal.toFixed(2).replace('.', ',');
            document.getElementById('total-value').textContent = subtotal.toFixed(2).replace('.', ',');
        }

        renderCartItems();
        calculateTotals();

        // 4. Inicializar ao carregar p√°gina
        renderCartItems();
        calculateTotals();

        // Fun√ß√£o para atualizar quantidade
        function updateQuantity(itemId, change) {
            const item = cartItems.find(i => i.id == itemId);
            if (item) {
                item.quantity += change;
                if (item.quantity < 1) item.quantity = 1;
                
                // Atualizar UI
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                const quantityElement = itemElement.querySelector('.quantity');
                const subtotalElement = itemElement.querySelector('.subtotal');
                
                quantityElement.textContent = item.quantity;
                subtotalElement.textContent = (item.price * item.quantity).toFixed(2).replace('.', ',');
                
                calculateTotals();
            }
        }

        // Fun√ß√£o para remover item
        function removeItem(itemId) {
            if (confirm('Deseja remover este item do pedido?')) {
                cartItems = cartItems.filter(i => i.id != itemId);
                document.querySelector(`[data-item-id="${itemId}"]`).remove();
                calculateTotals();
                
                if (cartItems.length === 0) {
                    document.getElementById('cart-items').innerHTML = 
                        '<div class="text-center py-8 text-gray-500">Seu carrinho est√° vazio</div>';
                }
            }
        }

        // Event listeners para bot√µes de quantidade
        document.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const change = this.classList.contains('plus') ? 1 : -1;
                updateQuantity(itemId, change);
            });
        });

        // Event listeners para remover itens
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                removeItem(itemId);
            });
        });

        // Modal de endere√ßos
        document.getElementById('change-address-btn').addEventListener('click', function() {
            document.getElementById('address-modal').classList.remove('hidden');
        });

        document.getElementById('close-address-modal').addEventListener('click', function() {
            document.getElementById('address-modal').classList.add('hidden');
        });

        // Sele√ß√£o de endere√ßo
        document.querySelectorAll('.address-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remover sele√ß√£o anterior
                document.querySelectorAll('.address-radio').forEach(radio => {
                    radio.classList.remove('bg-yellow-99', 'border-yellow-99');
                    radio.classList.add('border-gray-300');
                });
                
                // Adicionar sele√ß√£o atual
                const radio = this.querySelector('.address-radio');
                radio.classList.remove('border-gray-300');
                radio.classList.add('bg-yellow-99', 'border-yellow-99');
                
                // Fechar modal ap√≥s sele√ß√£o
                setTimeout(() => {
                    document.getElementById('address-modal').classList.add('hidden');
                }, 300);
            });
        });

        // Adicionar novo endere√ßo
        document.getElementById('add-address-btn').addEventListener('click', function() {
            // Redirecionar para p√°gina de cadastro de endere√ßo
            window.location.href = 'endereco.html';
        });

        // Voltar ao carrinho
        document.getElementById('back-to-cart-btn').addEventListener('click', function() {
            window.location.href = '/';
        });

        // Confirmar pedido
        document.getElementById('confirm-order-btn').addEventListener('click', function() {
            let cartItems = getCartItems();
            if (cartItems.length === 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }

            const orderData = {
                items: cartItems,
                notes: document.getElementById('order-notes').value,
                address: document.getElementById('selected-address').innerText,
                total: document.getElementById('total-value').textContent
            };

            this.textContent = 'Processando...';
            this.disabled = true;

            fetch('/pedido/finalizar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(orderData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    localStorage.removeItem('carrinho'); // Limpa o carrinho
                    document.getElementById('success-modal').classList.remove('hidden');
                } else {
                    alert('Erro ao finalizar pedido!');
                }
                this.textContent = 'Confirmar Pedido';
                this.disabled = false;
            })
            .catch(() => {
                alert('Erro ao finalizar pedido!');
                this.textContent = 'Confirmar Pedido';
                this.disabled = false;
            });
        });

        // Fechar modal de sucesso
        document.getElementById('close-modal-btn').addEventListener('click', function() {
            document.getElementById('success-modal').classList.add('hidden');
            // Redirecionar para p√°gina inicial ou pedidos
            window.location.href = '/';
        });

        // Acompanhar pedido
        document.getElementById('track-order-btn').addEventListener('click', function() {
            // Redirecionar para p√°gina de acompanhamento (implementar)
            alert('Redirecionando para acompanhamento do pedido...');
        });

        // Calcular totais iniciais
        calculateTotals();
    </script>
{% endblock scripts %}